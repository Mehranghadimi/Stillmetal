<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aluminothermic Reduction Calculator</title>

  <!-- Import CSS -->
  <link rel="stylesheet" href="style.css" />

  <!-- Pyodide (needed for the XML â†’ CSV analyzer) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Aluminothermic Reduction Calculator</h1>
      <span class="tag">StillMetal project</span>
      <button class="btn" id="runTests" title="Run built-in self tests">Run self-test</button>
    </header>

    <div class="grid">
      <!-- Left card: inputs -->
      <div class="card section">
        <h2>1) Enter oxide quantities (g)</h2>
        <div class="fieldset" id="inputs-main">
          <div class="row"><label for="CaO">CaO</label><input id="CaO" type="number" min="0" step="0.01" value="0"></div>
          <div class="row"><label for="MgO">MgO</label><input id="MgO" type="number" min="0" step="0.01" value="0"></div>
          <div class="row"><label for="Al2O3">Al2O3</label><input id="Al2O3" type="number" min="0" step="0.01" value="0"></div>
          <div class="row"><label for="SiO2">SiO2</label><input id="SiO2" type="number" min="0" step="0.01" value="0"></div>
        </div>

        <hr class="rule"/>

        <h2>Iron oxide</h2>
        <div class="fieldset">
          <div class="row">
            <label for="ironSelect">Select one</label>
            <select id="ironSelect">
              <option value="FeO">FeO</option>
              <option value="Fe2O3">Fe2O3</option>
              <option value="Fe3O4">Fe3O4</option>
            </select>
          </div>
          <div class="row"><label for="IronQty">Iron oxide amount (g)</label><input id="IronQty" type="number" min="0" step="0.01" value="0"></div>
        </div>

        <hr class="rule"/>

        <h2>Other oxides</h2>
        <div class="fieldset" id="inputs-other">
          <div class="row"><label for="P2O5">P2O5</label><input id="P2O5" type="number" min="0" step="0.01" value="0"></div>
          <div class="row"><label for="Cr2O3">Cr2O3</label><input id="Cr2O3" type="number" min="0" step="0.01" value="0"></div>
          <div class="row"><label for="MnO">MnO</label><input id="MnO" type="number" min="0" step="0.01" value="0"></div>
          <div class="row"><label for="TiO2">TiO2</label><input id="TiO2" type="number" min="0" step="0.01" value="0"></div>
        </div>

        <div class="toolbar" style="margin-top:14px;">
          <button class="btn primary" id="run">Run initial calculation</button>
          <button class="btn" id="loadSample">Load sample</button>
          <span class="note">Units: grams (g). Leave 0 if not present.</span>
        </div>
      </div>

      <!-- Right card: C/A sweep -->
      <div class="card section">
        <h2>2) C/A ratio sweep</h2>
        <div class="fieldset">
          <div class="row"><label for="startRatio">Start ratio (C/A)</label><input id="startRatio" type="number" min="0.01" step="0.01" value="0"></div>
          <div class="row"><label for="endRatio">End ratio (C/A)</label><input id="endRatio" type="number" min="0.01" step="0.01" value="0"></div>
          <div class="row"><label for="stepRatio">Step</label><input id="stepRatio" type="number" min="0.01" step="0.01" value="0"></div>
        </div>
        <div class="toolbar" style="margin-top:14px;">
          <button class="btn success" id="sweep" disabled>Generate table</button>
          <button class="btn" id="downloadCSV" disabled>Download CSV</button>
          <span class="note">(Generate is disabled until you click "Run initial calculation".)</span>
        </div>

        <div class="results" id="initialStats" style="display:none;">
          <div class="stat"><span class="k">Initial C/S (CaO/SiO2)</span><span class="v" id="statCS">â€“</span></div>
          <div class="stat"><span class="k">Al for initial reduction (g)</span><span class="v" id="statAl">â€“</span></div>

          <div class="stat"><span class="k">Si formed (g)</span><span class="v" id="statSi">â€“</span></div>
          <div class="stat"><span class="k">Fe formed (g)</span><span class="v" id="statFe">â€“</span></div>
          <div class="stat"><span class="k">Total FeSi25 alloy possible (g)</span><span class="v" id="statFeSi25">â€“</span></div>
          <div class="stat"><span class="k">Additional Fe needed for FeSi25 (g)</span><span class="v" id="statExtraFe25">â€“</span></div>

          <div class="stat"><span class="k">Al2O3 formed (g)</span><span class="v" id="statAl2O3">â€“</span></div>
          <div class="stat"><span class="k">Initial Al2O3 (g)</span><span class="v" id="statAl2O3Init">â€“</span></div>
          <div class="stat"><span class="k">Total Al2O3 in system (g)</span><span class="v" id="statAl2O3Total">â€“</span></div>
          <div class="stat"><span class="k">CaO / Al2O3 (Total) ratio</span><span class="v" id="statCATotal">â€“</span></div>

          <div class="stat" style="grid-column:1/3;">
            <span class="k">Raw quantities entered</span>
            <pre id="rawList" class="rawlist-pre"></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- 3) Results table -->
    <div class="card section" id="resultsCard" style="margin-top:16px; display:none;">
      <h2>3) Results table</h2>
      <div class="note" style="margin-bottom:8px;">Table appears only after you Generate.</div>
      <div id="resultsContainer" style="overflow:auto; display:none;">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>C/A Ratio</th>
              <th>Al Needed (g)</th>
              <th>Extra SiO2 Added (g)</th>
              <th>Leftover Slag (g)</th>
              <th>Leftover Basicity (C/S)</th>
              <th>FeSi<sub>25</sub> Result (g)</th>
              <th>Extra Fe Needed (g)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- 4) Alloy Fe requirements -->
    <div class="card section" id="alloyCard" style="margin-top:16px; display:none;">
      <h2>4) Additional Iron Needed for FeSi Alloys</h2>
      <div id="alloyContainer" style="overflow:auto; display:none;">
        <table id="alloyTable">
          <thead>
            <tr>
              <th>C/A Ratio</th>
              <th> Fe for FeSi30 (g)</th>
              <th> Fe for FeSi35 (g)</th>
              <th> Fe for FeSi40 (g)</th>
              <th> Fe for FeSi45 (g)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- 5) Oxideâ€“Temperature table -->
    <div class="card section" id="crossCard" style="margin-top:16px; display:none;">
      <h2>5) Oxideâ€“Temperature table</h2>
      <div class="toolbar" style="margin-bottom:10px;">
        <input id="tempInput" type="text" 
              placeholder="Temperature input: 1200 or 1100, 1400, 100 or 1150, 1250, 1350" />
        <button class="btn success" id="genCross" disabled>Generate oxideâ€“temperature table</button>
        <button class="btn" id="downloadCross" disabled>Download CSV</button>
        <button class="btn" id="copyCross" title="Copy table values" style="margin-left:auto">ðŸ“‹ Copy</button>
      </div>
      <div id="crossContainer" style="overflow:auto; display:none;">
        <table id="crossTable">
          <thead><tr id="crossHeader"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note">Temperature column is placed at the <strong>end</strong>. The final <strong>Viscosity</strong> column is editable and resets each time.</div>
    </div>

    <!-- 6) FactSage Equilib reactant (per C/A) -->
    <div class="card section" id="caChargeSection" style="margin-top:16px; display:none;">
      <h2>6) FactSage Equilib reactant</h2>
      <div class="toolbar ca-toolbar">
        <input id="caRangeInput" type="text" 
              placeholder="C/A e.g. 0.80 (for single value) or 0.75, 1.10, 0.05 (for range value)" />
        <select id="feSiGrade">
          <option value="25">FeSi25</option>
          <option value="30">FeSi30</option>
          <option value="35">FeSi35</option>
          <option value="40">FeSi40</option>
          <option value="45">FeSi45</option>
        </select>
        <button class="btn success" id="genCACharges" disabled>Generate charge tables</button>
      </div>
      <div id="caChargesContainer" style="display:none;"></div>
    </div>


    <!-- 7) XML â†’ CSV Analyzer -->
    <div class="card section" id="xmlAnalyzerCard" style="margin-top:16px;">
      <h2>7) XML â†’ CSV Analyzer</h2>
      <div id="dropZone" class="drop-zone">
        Drag & Drop XML file here or click to select
        <input type="file" id="xmlFileInput" accept=".xml" style="display:none">
      </div>
      <div id="xmlStatus" class="note" style="margin-top:10px;">Python not loaded yetâ€¦</div>
      <div id="xmlDownloadArea" style="display:none; margin-top:10px;">
        <a id="xmlDownloadLink" href="#" download="analysis.csv" class="btn success">Download CSV</a>
        <button class="btn" id="xmlCopyBtn">Copy CSV</button>
      </div>
    </div>
  </div><!-- /.wrap -->

  <!-- App logic split out -->
  <script src="app.js" defer></script>
  <!-- Python analyzer code (loaded by app.js via fetch and executed in Pyodide) -->
  <script id="analyzer-src" type="text/plain" data-src="main.py"></script>
</body>
</html>